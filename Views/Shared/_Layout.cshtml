<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - WebApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <link href="~/css/site.css?v=2" rel="stylesheet" />
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" asp-controller="Home" asp-action="Index">
                <i class="bi bi-globe2"></i> WebApp
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navContent">
                @if (User.Identity != null && User.Identity.IsAuthenticated)
                {
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Post" asp-action="Index">
                                <i class="bi bi-file-earmark-post"></i> Posts
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Contact" asp-action="Index">
                                <i class="bi bi-people"></i> Επαφές
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Message" asp-action="Index">
                                <i class="bi bi-chat-dots"></i> Μηνύματα
                                <span id="unreadBadge" class="badge bg-danger d-none">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Notification" asp-action="Index">
                                <i class="bi bi-bell"></i> Ειδοποιήσεις
                                <span id="notifBadge" class="badge bg-warning text-dark d-none">0</span>
                            </a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <span class="nav-link text-light">
                                <i class="bi bi-person-circle"></i> @User.Identity.Name
                            </span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Account" asp-action="Logout">
                                <i class="bi bi-box-arrow-right"></i> Αποσύνδεση
                            </a>
                        </li>
                    </ul>
                }
                else
                {
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Account" asp-action="Login">
                                <i class="bi bi-box-arrow-in-right"></i> Σύνδεση
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Account" asp-action="Register">
                                <i class="bi bi-person-plus"></i> Εγγραφή
                            </a>
                        </li>
                    </ul>
                }
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show">
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show">
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @RenderBody()
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <!-- Toast container -->
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1090;"></div>

    <!-- Page-specific scripts load first so handlers like onReceiveMessage are defined -->
    @await RenderSectionAsync("Scripts", required: false)

    @if (User.Identity != null && User.Identity.IsAuthenticated)
    {
        <script>
            // SignalR connections for real-time messages & notifications
            const userId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';

            // Message Hub
            const messageConnection = new signalR.HubConnectionBuilder()
                .withUrl("/messageHub")
                .withAutomaticReconnect()
                .build();

            messageConnection.on("ReceiveMessage", function (data) {
                console.log('ReceiveMessage event:', data);
                updateUnreadBadge();
                // If on conversation page, append message
                if (typeof onReceiveMessage === 'function') {
                    onReceiveMessage(data);
                }
            });

            messageConnection.start().then(function () {
                console.log('MessageHub connected, joining group user_' + userId);
                return messageConnection.invoke("JoinUserGroup", userId);
            }).then(function() {
                console.log('Joined message group successfully');
            }).catch(function (err) {
                console.error('MessageHub error:', err);
            });

            // Notification Hub
            const notifConnection = new signalR.HubConnectionBuilder()
                .withUrl("/notificationHub")
                .withAutomaticReconnect()
                .build();

            notifConnection.on("ReceiveNotification", function (data) {
                console.log('ReceiveNotification event:', data);
                updateNotifBadge();
                showToast(data.title, data.content);
            });

            notifConnection.start().then(function () {
                console.log('NotificationHub connected, joining group notifications_' + userId);
                return notifConnection.invoke("JoinUserNotifications", userId);
            }).then(function() {
                console.log('Joined notification group successfully');
            }).catch(function (err) {
                console.error('NotificationHub error:', err);
            });

            function updateUnreadBadge() {
                fetch('/Message/UnreadCount')
                    .then(r => r.json())
                    .then(data => {
                        const badge = document.getElementById('unreadBadge');
                        if (data.count > 0) {
                            badge.textContent = data.count;
                            badge.classList.remove('d-none');
                        } else {
                            badge.classList.add('d-none');
                        }
                    });
            }

            function updateNotifBadge() {
                fetch('/Notification/UnreadCount')
                    .then(r => r.json())
                    .then(data => {
                        const badge = document.getElementById('notifBadge');
                        if (data.count > 0) {
                            badge.textContent = data.count;
                            badge.classList.remove('d-none');
                        } else {
                            badge.classList.add('d-none');
                        }
                    });
            }

            function showToast(title, content) {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) return;
                const toastHtml = `
                    <div class="toast show" role="alert">
                        <div class="toast-header">
                            <strong class="me-auto">${title}</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${content}</div>
                    </div>`;
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                setTimeout(() => {
                    const t = toastContainer.querySelector('.toast');
                    if (t) t.remove();
                }, 5000);
            }

            // Initial load
            updateUnreadBadge();
            updateNotifBadge();
        </script>
    }
</body>
</html>
